pipeline {
    agent any
    
    environment {
        AWS_ACCESS_KEY_ID     = credentials('aws-access-key-id')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
        AWS_DEFAULT_REGION    = 'ap-south-1'
        ECR_REPOSITORY        = "804480554088.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com"
        ARTIFACTORY_URL       = 'http://13.127.195.27:8081/artifactory/'
        ARTIFACTORY_REPO      = 'libs-release/'
    }
    
    stages {
        stage('Build Stage') {
            agent {
                label 'jfrog'
            }
            steps {
                sh 'mvn clean install'
            }
            post {
                success {
                    script {
                        def server = Artifactory.newServer(url: ARTIFACTORY_URL, credentialsId: 'jfrog')
                        def rtMaven = Artifactory.newMavenBuild()
                        rtMaven.deployer server: server, releaseRepo: ARTIFACTORY_REPO, snapshotRepo: 'libs-snapshot/'
                        rtMaven.tool = 'maven'
                        rtMaven.run(pom: 'pom.xml', goals: 'clean install')
                    }
                }
            }
        }
        
        stage('Deploy and Push to ECR') {
            agent {
                label 'jfrog'
            }
            steps {
                script {
                    // Download artifact from Artifactory
                    sh '''
                        curl -o jenkins-test-1.0.jar ${ARTIFACTORY_URL}${ARTIFACTORY_REPO}com/example/jenkins-test/1.0/jenkins-test-1.0.jar
                    
                        # Log into AWS ECR
                        aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | docker login --username AWS --password-stdin ${ECR_REPOSITORY}
                        if [ $? -eq 0 ]; then
                            echo "Docker login successful"
                            # Build Docker image
                            sudo docker build -t sstest .
                    
                            # Tag Docker image
                            sudo docker tag sstest:latest ${ECR_REPOSITORY}/sstest:latest
                    
                            # Push Docker image to ECR
                            sudo docker push ${ECR_REPOSITORY}/sstest:latest
                        else
                            echo "Docker login failed"
                            exit 1
                        fi
                    '''
                }
            }
        }
    }
}
